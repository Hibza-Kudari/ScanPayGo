{% extends "base.html" %}
{% block content %}

<div class="page-section">
  <h2 class="mb-3">Select Seats - {{ bus.operator }} ({{ bus.bus_type }})</h2>

  <div class="row g-4 align-items-start">

    <!-- LEFT: Seat grid -->
    <div class="col-lg-7 col-12">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body">
          <h6 class="text-muted mb-3">Bus Layout ({{ bus.total_seats }} seats)</h6>

          <div class="small text-muted mb-2">
            <span class="badge bg-light text-dark border me-1">Available</span>
            <span class="badge bg-secondary me-1">Booked</span>
            <span class="badge bg-success me-1">Selected</span>
          </div>

          <div id="seat-grid"
               class="seat-grid"
               data-total="{{ bus.total_seats }}"
               data-price="{{ bus.price }}">
            {% for seat in range(1, bus.total_seats + 1) %}
              {% set is_booked = seat in booked_seats %}
              <button
                type="button"
                class="seat-btn btn btn-sm
                  {% if is_booked %} seat-booked btn-secondary
                  {% else %} seat-available btn-outline-secondary {% endif %}"
                data-seat="{{ seat }}"
                {% if is_booked %}disabled{% endif %}
              >
                {{ seat }}
              </button>
              {% if seat % 4 == 0 %}
                <div class="w-100 d-none d-md-block"></div>
              {% endif %}
            {% endfor %}
          </div>

          <!-- Hidden field that JS fills for POST -->
          <input type="hidden" id="selected_seats" name="selected_seats" form="booking-form">
        </div>
      </div>
    </div>

    <!-- RIGHT: Passenger & fare -->
    <div class="col-lg-5 col-12">
      <div class="card p-4 shadow-sm" style="border-radius: 24px;">
        <h5 class="mb-3">Passenger Details</h5>

        <form method="post" id="booking-form">
          <!-- NAME (auto-filled from login) -->
          <label class="form-label">Name</label>
          <input type="text"
                 name="name"
                 class="form-control"
                 value="{{ user.name }}"
                 readonly>

          <!-- EMAIL (auto-filled from login) -->
          <label class="form-label mt-3">Email</label>
          <input type="email"
                 name="email"
                 class="form-control"
                 value="{{ user.email }}"
                 readonly>

          <!-- PHONE (user can edit / add) -->
          <label class="form-label mt-3">Phone</label>
          <input type="text"
                 name="phone"
                 class="form-control"
                 value="{{ user.phone or '' }}"
                 placeholder="(Not set)">

          <!-- SELECTED SEATS (live-updated) -->
          <label class="form-label mt-3">Selected Seats</label>
          <input type="text"
                 id="selected-seats-display"
                 class="form-control"
                 value="None"
                 readonly>

          <!-- ESTIMATED FARE (live-updated) -->
          <label class="form-label mt-3">Estimated Fare</label>
          <input
            type="text"
            id="fare-display"
            class="form-control"
            readonly
            value="₹{{ '%.2f'|format(bus.price) }} per seat (updated after seat selection)"
          >

          <button class="btn btn-primary w-100 mt-4" type="submit">
            Continue to Payment
          </button>
        </form>
      </div>
    </div>

  </div>

  <!-- Route summary below the two columns -->
  <div class="card shadow-sm border-0 mt-4">
    <div class="card-body small text-muted">
      <div><strong>Route:</strong> {{ bus.from_city }} → {{ bus.to_city }}</div>
      <div><strong>Departure:</strong> {{ bus.departure }}</div>
      <div><strong>Arrival:</strong> {{ bus.arrival }}</div>
      <div><strong>Fare per seat:</strong> ₹{{ "%.2f"|format(bus.price) }}</div>
    </div>
  </div>
</div>

<!-- Inline script so seat selection always works -->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const seatGrid = document.getElementById("seat-grid");
  const selectedSeatsInput = document.getElementById("selected_seats");
  const selectedSeatsDisplay = document.getElementById("selected-seats-display");
  const fareDisplay = document.getElementById("fare-display");

  if (!seatGrid || !selectedSeatsInput || !selectedSeatsDisplay || !fareDisplay) {
    return;
  }

  const pricePerSeat = parseFloat(seatGrid.dataset.price || "0");

  seatGrid.addEventListener("click", function (e) {
    const btn = e.target.closest(".seat-btn");
    if (!btn || btn.classList.contains("seat-booked")) return;

    // Toggle selected state
    btn.classList.toggle("seat-selected");

    // Collect selected seats
    const selected = Array.from(
      seatGrid.querySelectorAll(".seat-btn.seat-selected")
    )
      .map((b) => b.getAttribute("data-seat"))
      .sort((a, b) => parseInt(a) - parseInt(b));

    if (selected.length === 0) {
      selectedSeatsDisplay.value = "None";
      fareDisplay.value =
        `₹${pricePerSeat.toFixed(2)} x 0 = ₹0.00`;
    } else {
      selectedSeatsDisplay.value = selected.join(", ");
      const total = selected.length * pricePerSeat;
      fareDisplay.value =
        `₹${pricePerSeat.toFixed(2)} x ${selected.length} = ₹${total.toFixed(2)}`;
    }

    // Update hidden input for form submit
    selectedSeatsInput.value = selected.join(",");
  });
});
</script>

{% endblock %}